<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop_layout}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <title>주문 및 결제</title>
</head>
<body>
    <!-- content -->
    <div layout:fragment="content">
        <div class="row">
            <div class="col">
                <h1>주문 및 결제</h1>
            </div>
        </div>
        <!-- 구매자 정보 -->
        <div class="row">
            <div class="col">구매자 정보</div>
        </div>
        <div class="row">
            <div class="col">
                <table class="table">
                    <tr>
                        <td>이름</td>
                        <td th:text="${member != null ? member.name : '정보 없음'}"></td>
                    </tr>
                    <tr>
                        <td>이메일</td>
                        <td th:text="${member != null ? member.email : '정보 없음'}"
                            id="memberEmail"></td>
                    </tr>
                    <tr>
                        <td>연락처</td>
                        <td th:text="${member != null ? member.mobile : '정보 없음'}"></td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- 받는사람 정보 -->
        <div class="row">
            <div class="col">받는 사람 정보</div>
        </div>
        <div class="row">
            <div class="col">
                <table class="table">
                    <tr>
                        <td>이름</td>
                        <td th:text="${member != null ? member.name : '정보 없음'}"></td>
                    </tr>
                    <tr>
                        <td>주소</td>
                        <td th:text="${member != null ? member.address1 : '정보 없음'}"></td>
                    </tr>
                    <tr>
                        <td>연락처</td>
                        <td th:text="${member != null ? member.mobile : '정보 없음'}"></td>
                    </tr>
                    <tr>
                        <td>배송 요청 사항</td>
                        <td>*</td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- 상품 정보 -->
        <div class="row">
            <div class="col">주문 상품 정보</div>
        </div>
        <div class="row">
            <div class="col-8" id="productContainer">
                <div th:if="${cartDetails != null}">
                    <!-- 장바구니 품목 -->
                    <th:block th:each="item : ${cartDetails}">
                        <div class="row cartBox" th:data-product-id="${item.productId}">
                            <div class="col productImage">
                                <img class="product-image" th:src="${item.productImage != null and #strings.startsWith(item.productImage, 'http') ? item.productImage : '/resources/shop/' + item.productImage}" alt="Product Image">
                            </div>
                            <div class="col">
                                <p class="product-name" th:text="${item.productName}"></p>
                                <p class="price" th:data-price="${item.price}" th:text="${item.price}"></p>
                                <div class="quantity-input-container">
                                    <div class="quantity-input-minus">-</div>
                                    <input class="quantity-input" type="text" th:value="${item.quantity}" />
                                    <div class="quantity-input-plus">+</div>
                                </div>
                                <p class="totalPrice" th:data-price="${item.quantity * item.price}" th:text="${item.quantity * item.price}"></p>
                            </div>
                            <div class="col deleteCart">
                                <i class="bi bi-trash3"></i>
                            </div>
                        </div>
                    </th:block>
                </div>
                <!-- 바로 구매시 -->
                <div th:if="${cart != null}">
                    <div class="row cartBox" th:data-product-id="${cart.productId}">
                        <div class="col productImage">
                            <img class="product-image" th:src="${cart.productImage != null and #strings.startsWith(cart.productImage, 'http') ? cart.productImage : '/resources/shop/' + cart.productImage}" alt="Product Image">
                        </div>
                        <div class="col">
                            <p class="product-name" th:text="${cart.productName}"></p>
                            <p class="price" th:data-price="${cart.price}" th:text="${cart.price}"></p>
                            <div class="quantity-input-container">
                                <div class="quantity-input-minus">-</div>
                                <input class="quantity-input" type="text" th:value="${cart.quantity}" />
                                <div class="quantity-input-plus">+</div>
                            </div>
                            <p class="totalPrice" th:data-price="${cart.quantity * cart.price}" th:text="${cart.quantity * cart.price}"></p>
                        </div>
                        <div class="col deleteCart">
                            <i class="bi bi-trash3"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4 orderBox">
                <div class="">
                    <h2>주문 예상 금액</h2>
                    <div>
                        상품 총액: <span id="totalProductPrice" class="price" th:data-price="0"></span>
                    </div>
                    <div>
                        할인 총액: <span id="totalDiscountPrice" th:data-price="0">0</span> 원
                    </div>
                    <div>
                        배송 총액: <span id="totalDeliveryPrice" th:data-price="0">0</span> 원
                    </div>
                </div>
                <div>
                    합계금액: <span id="totalOrderPrice" class="price" th:data-price="0" th:text="${totalAmount}"></span>
                </div>
            </div>
        </div>
        <!-- 결제 UI -->
        <div id="payment-method"></div>
        <div id="agreement"></div>
        <!-- 결제하기 버튼 -->
        <button id="payment-button">결제하기</button>
        <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            function generateRandomString(length) {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                const charactersLength = characters.length;
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }
                return result;
            }

            const orderId = generateRandomString(10);
            const customerKey = generateRandomString(10);
            const amount = parseInt(document.getElementById('totalOrderPrice').innerText, 10);
            const button = document.getElementById("payment-button");
            const widgetClientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const paymentWidget = PaymentWidget(widgetClientKey, customerKey);
            paymentWidget.renderPaymentMethods("#payment-method", { value: amount }, { variantKey: "DEFAULT" });
            paymentWidget.renderAgreement("#agreement", { variantKey: "AGREEMENT" });

            let orderName = '';
            const cartDetails = /*[[${session.cartDetails}]]*/ [];
            const cart = /*[[${session.cart}]]*/ null;

            if (cartDetails && cartDetails.length > 1) {
                orderName = cartDetails[0].productName + ' 외 ' + (cartDetails.length - 1) + '건';
            } else if (cart) {
                orderName = cart.productName;
            }

            function getCartItems() {
                const items = [];
                const cartBoxes = document.querySelectorAll('.cartBox');
                cartBoxes.forEach(box => {
                    const productId = box.dataset.productId;
                    const quantityElement = box.querySelector('.quantity-input');
                    const productNameElement = box.querySelector('.product-name');
                    const priceElement = box.querySelector('.price');
                    const productImageElement = box.querySelector('.product-image');

                    if (productNameElement && quantityElement && priceElement && productImageElement) {
                        const quantity = quantityElement.value;
                        const productName = productNameElement.innerText;
                        const price = priceElement.dataset.price;
                        const productImage = productImageElement.src;

                        items.push({
                            productId: parseInt(productId, 10),
                            productName: productName,
                            price: parseInt(price, 10),
                            quantity: parseInt(quantity, 10),
                            productImage: productImage
                        });
                    } else {
                        console.error("Missing product details in cart item", box);
                    }
                });
                return items;
            }

            button.addEventListener("click", function () {
                const items = getCartItems();
                const formData = {
                    orderId: orderId,
                    customerKey: customerKey,
                    amount: amount,
                    orderName: orderName,
                    memberEmail: document.getElementById('memberEmail').innerText,
                    items: items
                };

                fetch('/order/saveOrder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          paymentWidget.requestPayment({
                              orderId: orderId,
                              orderName: orderName,
                              successUrl: window.location.origin + "/success",
                              failUrl: window.location.origin + "/fail"
                          });
                      } else {
                          console.error("Order save failed:", data.message);
                      }
                  }).catch(error => {
                      console.error("Error:", error);
                  });
            });
        });
        </script>
    </div>
</body>
</html>
