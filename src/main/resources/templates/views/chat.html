<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/user_layout}">

<!-- content -->
<div layout:fragment="content" class="row my-3" id="global-content">
	<script th:src="@{/js/chat.js}"></script>
	<div class="col">
		<div class="col-md-8 offset-md-2">
			<h2>Manager 문의사항</h2>
			<div class="row">
				<div class="col-md-8">
					<div class="chat-container">
						<div class="chat-messages" id="chatMessages">
							<!-- Chat messages will be displayed here -->
							<div class="message">
								<strong>Manager:</strong> 안녕하세요~ 무슨 일로 찾으셨나요?
							</div>
						</div>
						<form id="sendMessageForm">
							<div class="row my-3">
								<div class="col-md-10">
									<div class="form-group">
										<textarea class="form-control" id="messageInput" rows="3"
											placeholder="Type your message..." style="resize: none;"></textarea>
									</div>
								</div>
								<div class="col-md">
									<button type="submit" class="btn btn-success">송신</button>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="col-md-4">
					<h4>사용자 목록</h4>
					<div id="userListContainer"
						style="max-height: 400px; overflow-y: auto;">
						<ul id="userList" class="list-group">
							<li th:each="member : ${userList}"
								class="list-group-item user-item"
								th:attr="data-member-id=${member.id}"><span
								th:text="${member.id}"></span> <span th:text="${member.name}"></span>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script th:inline="javascript">

	let userId = [[${ session.member.id }]];
	const websocket = new WebSocket("ws://" + window.location.host + "/ws/chat");
	
	websocket.onopen = function(event) {
	    console.log("WebSocket 연결 성공");
	    websocket.send(userId + ": 님이 입장했습니다.");
	};
	
	websocket.onclose = function(event) {
	    console.log("WebSocket 연결 종료");
	    websocket.send(userId + ": 님이 방을 나갔습니다.");
	};
	
	websocket.onmessage = function(event) {
	    console.log("메시지 수신:", event.data);
	    let message = event.data;
	  	console.log(message);
	    displayMessage(message);
	};
	
	function send() {
	    console.log(userId, " : ", $("#messageInput").val());
	    websocket.send(userId + ":" + $("#messageInput").val());
		$("#messageInput").val("");
	}
	
	$("#sendMessageForm").submit(function(event) {
	    event.preventDefault();
	    websocket.send(userId + ":" + $("#messageInput").val());
	    $("#messageInput").val("");
	});
	
	$('#messageInput').keydown(function(e) {
	    if (e.keyCode == 13 && !e.shiftKey) {
	        e.preventDefault();
	        $('#sendMessageForm').submit();
	    }
	});

	function onMessage(msg) {
	    let data = msg.data;
	    let arr = data.split(":");
	    let sessionId = arr[0];
	    let message = arr.slice(1).join(":");

	    let curSession = userId; // 현재 사용자 세션 ID

	    // 메시지 출력
	    displayMessage(sessionId, message, curSession);
	}

	function displayMessage(sessionId, message, curSession) {
	    let messageHtml;
	    
	    if (sessionId === curSession) { // 자신의 메시지인 경우
	        messageHtml = '<div class="msg_box my-2">'
	                    + '<div class="card bg-orange text-white">'
	                    + '<div class="card-body">'
	                    + '<p class="card-text">' + sessionId + (message ? ' : ' + message : '') + '</p>'
	                    + '</div>'
	                    + '</div>'
	                    + '</div>';
	    } else { // 다른 사용자의 메시지인 경우
	        messageHtml = '<div class="msg_box my-2">'
	                    + '<div class="card bg-warning">'
	                    + '<div class="card-body">'
	                    + '<p class="card-text">' + sessionId + (message ? ' : ' + message : '') + '</p>'
	                    + '</div>'
	                    + '</div>'
	                    + '</div>';
	    }

	    $("#chatMessages").append(messageHtml);
	    scrollToBottom();
	}

	function scrollToBottom() {
	    $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
	}

</script>
</div>
</html>
