<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/shop_layout}">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://js.tosspayments.com/v1/payment-widget"></script>
 
<title>주문 및 결제</title>
</head>

<body>
	<!-- content -->
	<div layout:fragment="content" class="shopOrder-content">
		<div class="row">
			<div class="col">
				<h2 class="order-title">주문 및 결제</h2>
			</div>
		</div>

		<!-- 구매자 정보 -->
		<div class="row">
			<div class="col order-info">구매자 정보</div>
		</div>
		<div class="row">
			<div class="col-11">
				<table class="table order-info-buy">
					<tr class="order-infos">
						<td>이름</td>
						<td th:text="${member != null ? member.name : '정보 없음'}"></td>
					</tr>
					<tr class="order-infos">
						<td>이메일</td>
						<td th:text="${member != null ? member.email : '정보 없음'}"
							id="memberEmail"></td>
					</tr>
					<tr class="order-infos">
						<td>연락처</td>
						<td th:text="${member != null ? member.mobile : '정보 없음'}"></td>
					</tr>
				</table>
			</div>
		</div>

		<!-- 받는사람 정보 -->
		<div class="row">
			<div class="col order-info2">받는 사람 정보</div>
		</div>
		<div class="row">
			<div class="col-11">
				<table class="table order-info-buy">
					<tr class="order-infos">
						<td>이름</td>
						<td th:text="${member != null ? member.name : '정보 없음'}"></td>
					</tr>
					<tr class="order-infos">
						<td>주소</td>
						<td th:text="${member != null ? member.address1 : '정보 없음'}"></td>
					</tr>
					<tr class="order-infos">
						<td>연락처</td>
						<td th:text="${member != null ? member.mobile : '정보 없음'}"></td>
					</tr>
					<tr class="order-infos">
						<td>배송 요청 사항</td>
						<td>*</td>
					</tr>
				</table>
			</div>
		</div>

		<!-- 상품 정보 -->
		
		<div class="row">
			<div class="col order-info2">주문 상품 정보</div>
		</div>
		<div class="row">
			<div class="col" id="productContainer">
				<div th:if="${cartDetails != null}">
					<!-- 장바구니 품목 -->
					<th:block th:each="item : ${cartDetails}">
						<div class="row cartBox" th:data-product-id="${item.productId}">
							<div class="col productImage">

								<img
									th:src="@{${item.productImage} != null ? ${item.productImage} : '/resources/shop/' + ${item.productImage} }">
							</div>
							<div class="col">
								<p th:text="${item.productName}"></p>
								<p class="price" th:data-price="${item.price}"
									th:text="${item.price}"></p>

								<div class="quantity-input-container">
									<div class="quantity-input-minus">
										<i class="bi bi-dash quantity-icon"></i>
									</div>
									<input class="quantity-input" type="text"
										th:value="${item.quantity}" />
									<div class="quantity-input-plus">
										<i class="bi bi-plus quantity-icon"></i>
									</div>
								</div>
								<p class="totalPrice"
									th:data-price="${item.quantity * item.price}"
									th:text="${item.quantity * item.price}"></p>
							</div>
							<div class="col deleteCart">
								<i class="bi bi-trash3"></i>
							</div>
						</div>
					</th:block>
				</div>

				<!-- 바로 구매시 -->
				<div th:if="${cart != null}">
					<div class="row cartBox" th:data-product-id="${cart.productId}">
						<div class="col-4 productImage">
							<img
								th:src="@{${cart.productImage} != null ? ${cart.productImage} : '/resources/shop/' + ${cart.productImage} }">
						</div>
						<div class="col-6">
							<p th:utext="${cart.productName}"></p>
							<div class="">
							<p class="price" th:data-price="${cart.price}"
								th:utext="${cart.price}"></p>
							</div>	
							
							<div class="quantity-input-container">
								<div class="quantity-input-minus">
									<i class="bi bi-dash quantity-icon"></i>
								</div>
								<input class="quantity-input" type="text"
									th:value="${cart.quantity}" />
								<div class="quantity-input-plus">
									<i class="bi bi-plus quantity-icon"></i>
								</div>
								</div>
							
							<p class="totalPrice"
								th:data-price="${cart.quantity * cart.price}"
								th:utext="${cart.quantity * cart.price}"></p>
						</div>
						<div class="col-1 deleteCart">
							<i class="bi bi-trash3"></i>
						</div>
					</div>
				</div>
			</div>

			<div class="col-4 orderBox">
				<div>
					<h2 class="order-title3 text-center">주문 예상 금액</h2>
					<div class="price-total">
						상품 총액 : <span id="totalProductPrice" class="price"
							th:data-price="0"></span>
					</div>
					<div class="price-total">
						할인 총액 : <span id="totalDiscountPrice" th:data-price="0">0</span> 원
					</div>
					<div class="price-total">
						배송 총액 : <span id="totalDeliveryPrice" th:data-price="0">0</span> 원
					</div>
				</div>
				<div class="total-order-price"><b>
					합계금액: <span id="totalOrderPrice" class="price" th:data-price="0"
						th:text="${totalAmount}"></span></b>
				</div>
				</div>
			</div>


		<!-- 결제 UI -->
		<div id="payment-method"></div>
		<div id="agreement"></div>

		<!-- 결제하기 버튼 -->
		<div class="text-center">
		 <button id="payment-button" class="shopOrder-pay-btn">결제하기</button>
		</div>
		
		<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        console.log("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa");
        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        // Generate orderId and customerKey
        const orderId = generateRandomString(10); // Adjust length as needed
        const customerKey = generateRandomString(10); // Adjust length as needed
        
        // Get total order price from the data attribute
        const amount = parseInt(document.getElementById('totalOrderPrice').innerText, 10);

        console.log("가격총량", amount);
        // Get the payment button element
        const button = document.getElementById("payment-button");

        // Get memberId from the session
        const memberId = /*[[${session.member.id}]]*/ '[[${session.member.id}]]';
        console.log("memberId: " + memberId);

        // Initialize the payment widget with a predefined client key
        const widgetClientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";

        // Initialize the payment widget
        const paymentWidget = PaymentWidget(widgetClientKey, customerKey);

        // Render payment methods
        const paymentMethodWidget = paymentWidget.renderPaymentMethods(
            "#payment-method", {
                value: amount // Parse the total order price as an integer
            }, {
                variantKey: "DEFAULT"
            }
        );

        // Render agreement section
        paymentWidget.renderAgreement("#agreement", {
            variantKey: "AGREEMENT"
        });
        
        let orderName = '';
        const cartDetails = /*[[${session.cartDetails}]]*/ [];
        const cart = /*[[${session.cart}]]*/ null;
        const items = [];

        if (cartDetails != null && cartDetails.length > 0) {
            orderName = cartDetails[0].productName + ' 외 ' + (cartDetails.length - 1) + '건';
            cartDetails.forEach(item => {
                items.push({
                    productId: item.productId,
                    productName: item.productName,
                    productImage: item.productImage,
                    price: item.price,
                    quantity: item.quantity
                });
            });
        } else if (cart) {
            orderName = cart.productName;
            items.push({
                productId: cart.productId,
                productName: cart.productName,
                productImage: cart.productImage,
                price: cart.price,
                quantity: cart.quantity
            });
        }

        // Add event listener for the payment button
        button.addEventListener("click", function() {
            // Fetch to insert order information to the order table
            fetch('/order/saveOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    orderId: orderId,
                    memberId: memberId, // Add memberId from session
                    customerKey: customerKey,
                    amount: amount,
                    orderName: orderName,
                    items: items // Add items to the request
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Request payment after order information is successfully inserted
                    paymentWidget.requestPayment({
                        orderId: orderId,
                        orderName: orderName,
                        successUrl: window.location.origin + "/success",
                        failUrl: window.location.origin + "/fail"
                    });
                } else {
                    console.error('Order save failed:', data.message);
                    // Handle order save failure (e.g., show an error message to the user)
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error (show an error message to the user, etc.)
            });
        });
    });
</script>


	</div>
</body>
</html>
